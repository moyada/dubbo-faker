<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.moyada.sharingan.storage.mysql.dao.InvocationDAO">

	<resultMap id="resultDO" type="cn.moyada.sharingan.storage.api.domain.InvocationResultDO">
		<id column="id" property="id"/>
		<result column="faker_id" property="fakerId"/>
		<result column="real_args" property="realArgs"/>
		<result column="code" property="code"/>
		<result column="result" property="result"/>
		<result column="error_msg" property="errorMsg"/>
		<result column="response_time" property="responseTime"/>
		<result column="invoke_time" property="invokeTime"/>
	</resultMap>

	<resultMap id="reportDO" type="cn.moyada.sharingan.storage.api.domain.InvocationReportDO">
		<id column="faker_id" property="fakerId"/>
		<result column="app_id" property="appId"/>
		<result column="service_id" property="serviceId"/>
		<result column="func_id" property="funcId"/>
		<result column="total_invoke" property="totalInvoke"/>
		<result column="response_invoke" property="responseInvoke"/>
		<result column="min_response_time" property="minResponseTime"/>
		<result column="max_response_time" property="maxResponseTime"/>
		<result column="avg_response_time" property="avgResponseTime"/>
		<result column="date_create" property="dateCreate"/>
	</resultMap>

	<sql id="resultColumn">
		`id`, `faker_id`, `real_args`, `code`, `result`, `error_msg`, `response_time`, `invoke_time`
	</sql>

	<sql id="reportColumn">
		`faker_id`, `app_id`, `service_id`, `func_id`, `total_invoke`, `response_invoke`, `min_response_time`, `max_response_time`, `avg_response_time`, `date_create`
	</sql>

	<insert id="saveReport">
		INSERT INTO `invocation_report`
		(<include refid="reportColumn"/>)
		VALUE
		(#{fakerId}, #{appId}, #{serviceId}, #{funcId}, #{totalInvoke}, #{responseInvoke},
		#{minResponseTime}, #{maxResponseTime}, #{avgResponseTime}, #{dateCreate});
	</insert>

	<insert id="saveResult">
		INSERT INTO `invocation_result`
		(<include refid="resultColumn"/>)
		VALUE
		(NULL, #{fakerId}, #{realArgs}, #{code}, #{result}, #{errorMsg}, #{responseTime}, #{invokeTime});
	</insert>

	<insert id="saveBatchResult">
		INSERT INTO `invocation_result`
		(<include refid="resultColumn"/>)
		<foreach collection="list" item="item" separator="," open="VALUES">
			(NULL, #{item.fakerId}, #{item.realArgs}, #{item.code}, #{item.result},
			#{item.errorMsg}, #{item.responseTime}, #{item.invokeTime});
		</foreach>;
	</insert>

	<select id="findReport" resultMap="reportDO">
		SELECT <include refid="reportColumn"/>
		FROM `invocation_report`
		WHERE `faker_id` = #{fakerId}
	</select>

	<select id="findResult" resultMap="resultDO">
		SELECT <include refid="resultColumn"/>
		FROM `invocation_result` a,
		(
			SELECT id
			FROM `invocation_result`
			WHERE `faker_id` = #{fakerId}
			ORDER BY `code` DESC, `response_time` DESC
			LIMIT ${offset}, ${pageSize}
		) b
		WHERE a.`id` = b.`id`
	</select>
</mapper>